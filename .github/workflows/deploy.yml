name: Deploy

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'LICENSE'

jobs:
  deploy:
    name: Deploy to Deno Deploy
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Clone repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      # è½»é‡çº§ç¼“å­˜ï¼ˆDeno 2.0 ä¼˜åŒ–ï¼‰
      - name: Cache Deno dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/deno
            ~/.deno
          key: ${{ runner.os }}-deno-v2-${{ hashFiles('deno.json') }}
          restore-keys: |
            ${{ runner.os }}-deno-v2-
            ${{ runner.os }}-deno-

      # å¿«é€Ÿä¾èµ–ç¼“å­˜
      - name: Cache dependencies
        timeout-minutes: 1
        run: |
          echo "Caching dependencies..."
          deno cache --quiet --no-check main.ts || echo "Cache completed"

      # Deno 2.0 è¶…å¿«æ„å»º
      - name: Ultra Fast Build (Deno 2.0 Optimized)
        timeout-minutes: 2
        env:
          DENO_FUTURE: 1
          DENO_NO_PACKAGE_JSON: 1
          DENO_NO_UPDATE_CHECK: 1
        run: |
          echo "ğŸš€ Starting Deno 2.0 ultra fast build..."
          echo "ğŸ“¦ Deno version: $(deno --version | head -1)"

          # ç›´æ¥ä½¿ç”¨å·²éªŒè¯çš„ä¼˜åŒ–æ„å»º
          deno task build:deno2 || {
            echo "âš ï¸ Optimized build failed, using minimal build..."
            deno task build:minimal
          }

          echo "âœ… Build completed successfully"

      # éƒ¨ç½²åˆ° Deno Deploy
      - name: Deploy to Deno Deploy
        uses: denoland/deployctl@v1
        with:
          project: "denoauthent"
          entrypoint: "main.ts"
          root: "."
